\documentclass[a4paper, 12pt]{report}
%================================================================
\usepackage{color,amsmath,amsfonts,amssymb,epsfig,hyperref}
\usepackage{verbatim}
\usepackage{graphicx}
\usepackage{dsfont}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{pdfpages}
%====================================
 \textheight 24cm
% \doublespace
  \oddsidemargin -0.5cm
  \evensidemargin +1.5cm
  \textwidth 15cm
 \topmargin -2cm
%============================================
% Figures
%============================================
\newcommand{\figsstit}[2]{
\begin{figure}[hbtp]
\centerline{
    \hbox{ \includegraphics[scale=#2]{#1} }
}
\end{figure}}
%============================================
\newcommand{\figscale}[4]{
\begin{figure}[hbtp]
\centerline{
    \hbox{ \includegraphics[scale=#4]{#1} }
}
\begin{center}
\parbox{14 cm}
{
    \caption{\protect\small\it  {#2}}
    \label {#3}
}
\end{center}

\end{figure}}

%==================================================
\newcommand\algo[1]%
{
    \begin{center} %
    \begin{tabular} {||p{10 cm}l ||}%
    \hline
               #1 &  \\
    \hline
    \end{tabular}
    \vspace{12pt}
    \end{center}
}


%==============================================
\newcommand{\prob}[1]{\mathds{P}\left( #1 \right)}
\newcommand{\esp}[1]{\mathds{E}\left[ #1 \right]}
\newcommand{\var}[1]{\mathrm{var}\left( #1 \right)}
\newcommand{\cov}[1]{\mathrm{cov}\left( #1 \right)}
\newcommand{\diag}[1]{\mathrm{diag}\left( #1 \right)}
\newcommand{\trace}[1]{\mathrm{trace}\left( #1 \right)}
\newcommand{\card}[1]{\left| #1 \right|}
\newcommand{\myemph}[1]{\emph{\color{red}#1}}

%%============================================================================
\def\thesection{\arabic{section}}
%\def\thesubsection{\arabic{section}.\arabic{subsection}}
%\def\thesubsubsection{\arabic{section}.\arabic{subsection}.\arabic{subsubsection}}
%\def\thefigure{\arabic{figure}}
%\def\theequation{\arabic{equation}}
%\def\theexercice{\arabic{exercice}}
%\def\theexample{\arabic{example}}
%\def\theproof{\arabic{proof}}

%===============================================
\newtheorem{property}{Properties}
\newtheorem{remark}{Remark}
\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}
\newtheorem{lemme}{Lemme - \thelemme}
\newtheorem{proof}{Proof - \theproof}
\newenvironment{TAB}{\begin{table}[[hbt] \center \leavevmode}{\end{table}}
%%============================================================================
%\renewcommand\arraystretch{1.6}

\def\ua{\underline a}
\def\ub{\underline b}
\def\uB{\underline B}
\def\uH{\underline H}
\def\ur{\underline r}
\def\us{\underline s}
\def\ux{\underline x}
\def\uX{\underline X}
\def\uZ{\underline Z}
\def\utheta{\underline \theta}

\def\tn{\mathrm{TN}}
\def\fn{\mathrm{FN}}
\def\tp{\mathrm{TP}}
\def\fp{\mathrm{FP}}
\def\tpn{\mathrm{tPN}}
\def\tnn{\mathrm{tNN}}
\def\tdn{\mathrm{tDN}}

\def\precision{\mathrm{\color{red}Precision}}
\def\recall{\mathrm{\color{red}Recall}}
\def\fscore{{\color{red}F\mathrm{-score}}}
\def\far{\mathrm{FAR}}
\def\mdr{\mathrm{MDR}}
\def\vdr{\mathrm{VDR}}
\def\ci{\mathrm{CI}}
\def\pfa{P_{\mathrm{FA}}}
\def\pd{P_{\mathrm{D}}}
\def\loc{\mathrm{LOC}}

\def\SNR{\mathrm{SNR}}
\def\crb{\mathrm{CRB}}
\def\fim{\mathrm{FIM}}

\def\auc{\mathrm{AUC}}
\def\aec{\mathrm{aec}}



\def\void{{\small void}}
\def\nomeaning{{\small meaningless}}
\def\unknown{{\small unknown}}
\def\MSC{\mathrm{MSC}}
\def\hMSC{\widehat{\MSC}}%{\MSC}} 
\def\ellk{{k}}
\def\SOI{common signal part }
\def\absGamma{\Phi}

%============== colors ========================
\definecolor{enstrouge}{RGB}{212,65,84}
\definecolor{lightorange}{RGB}{235,226,52}
\definecolor{greennoise}{RGB}{243,42,255}
\definecolor{lightred}{RGB}{255,181,183}
\definecolor{light-grey}{rgb}{0.95,0.95,0.95}
\definecolor{peach}{rgb}{0.98,0.49,0.25}
\definecolor{burntorange}{rgb}{0.79,0.37,0}
\definecolor{light-yellow}{rgb}{1,1,0.92}

\definecolor{light-green}{RGB}{231,255,145}
\definecolor{enstorange}{RGB}{255,214,10}
\definecolor{enstrouge}{RGB}{212,65,84}
\definecolor{grey}{RGB}{204,204,204}
\definecolor{blue}{RGB}{0,0,255}
\definecolor{almost-black}{RGB}{100,100,100}
\definecolor{violet}{rgb}{0.4,0,0.4}
\definecolor{cyan}{RGB}{0,255,255}
\definecolor{magenta}{RGB}{243,42,255}

\def\degree{^{\circ}}
\def\simiid{\stackrel{\mathrm{i.i.d.}}{\sim}}
\def\simind{\stackrel{\mathrm{ind.}}{\sim}}

 
%%%============================================================================
%%\def\thesection{\arabic{section}}
%%\def\thefigure{\arabic{figure}}
%%\def\theequation{\arabic{equation}}
%%\def\theexercice{\arabic{exercice}}
%%\def\theequation{\arabic{exercice}.\arabic{equation}}
%%%============================================================================
%%\newcounter{auxiliaire}
%%%%%%%%% comment
%%\setcounter{auxiliaire}{\theenumi}
%%\end{enumerate}
%% TEXTE
%%\begin{enumerate}
%%\setcounter{enumi}{\theauxiliaire}
%%%============================================================================

 \bibliographystyle{plain} 

\begin{document}
 \sloppy
%=======================================================
%=======================================================
\section{Introduction}
A 3D seismic device measures the three components of an acceleration vector in three specific directions attached to the device. These three directions form a trihedron almost orthogonal but not exactly. We denote $v_{u,1}$,  $v_{u,2}$,  $v_{u,3}$ the unitary vectors of these 3 directions of the seismic device under test (SUT), and  $v_{r,1}$,  $v_{r,2}$,  $v_{r,3}$ those of the reference system (SREF). All vectors are referred to any given orthonormal coordinate system. We index by $x$, $y$ and $z$ the coordinates w.r.t. this coordinate system. It follows that the 3 signals on SUT write:
\begin{eqnarray}
\label{eq:signalsT}
\left\{
\begin{array}{rcl}
x_{u,1}(t)&=&h_{u,1}(t)\star (v_{u,1,x}g_{x}(t)+v_{u,1,y}g_{y}(t)+v_{u,1,z}g_{z}(t))
\\
x_{u,2}(t)&=&h_{u,2}(t)\star (v_{u,2,x}g_{x}(t)+v_{u,2,y}g_{y}(t)+v_{u,2,z}g_{z}(t))
\\
x_{u,3}(t)&=&h_{u,3}(t)\star (v_{u,3,x}g_{x}(t)+v_{u,3,y}g_{y}(t)+v_{u,3,z3}g_{z}(t))
\end{array}
\right.
\end{eqnarray}
where 
\begin{itemize}
\item
$t$ is discrete from $0$ to $N-1$, at the sampling frequency $F_{s}$. Typically for an observation time of $1000$ seconds and a sampling frequency of $40$, $N=40,\!000$;
\item
$x_{u,1}(t)$, $x_{u,2}(t)$, $x_{u,3}(t)$  are the 3 output signals of the accelerometer;
\item
$g_{x}(t)$, $g_{y}(t)$, $g_{z}(t)$ are the 3 components  of the acceleration;
\item
$v_{u,k,x}$, $v_{u,k,y}$, $v_{u,k,z}$ are the 3 components of the direction $k$ with $k$ from 1 to 3;
\item
and $h_{u,1}(t)$, $h_{u,2}(t)$, $h_{u,3}(t)$  are the 3 impulse responses of the accelerometer.
\end{itemize}

In frequency domain equations \eqref{eq:signalsT} can be rewritten:
\begin{eqnarray}
\label{eq:signalsF}
\left\{
\begin{array}{rcl}
X_{u,1}(f)&=&H_{u,1}(f) (v_{u,1,x}G_{x}(f)+v_{u,1,y}G_{y}(f)+v_{u,1,z}G_{z}(f))
\\
X_{u,2}(f)&=&H_{u,2}(f) (v_{u,2,x}G_{x}(f)+v_{u,2,y}G_{y}(f)+v_{u,2,z}G_{z}(f))
\\
X_{u,3}(f)&=&H_{u,3}(f) (v_{u,3,x}G_{x}(f)+v_{u,3,y}G_{y}(f)+v_{u,3,z}G_{z}(f))
\end{array}
\right.
\end{eqnarray}
Remaining that for $m=0$ to $N-1$:
\begin{eqnarray*}
X(f_{m})&=&\sum_{t=0}^{N-1}x(t)e^{-2j\pi f_{m}t}\quad \mathrm{with}\quad f_{m}=\frac{m}{N} 
\end{eqnarray*}
It is worth to notice that there is no coupling between the 3 filtering processing. That indices that the orientation of any of the 3 axes of the sensor has no effect on the other. It follows that we can estimate the orientations component by component.

More concisely for one component we can write
\begin{eqnarray*}
X_{u,k}(f)&=&H_{u,k}(f)v_{u,k}^{T}G(f)
\end{eqnarray*}
and where $v_{u,k}$ is a normalized column vector whose entries are $v_{u,k}$, therefore $v_{u,k}^{T}v_{u,k}=1$.  A possible parametrization in an arbitrary orthonormal coordinate system is:
\begin{eqnarray}
\label{eq:parametricformofV}
v(\phi_{u,k})&=&
\begin{bmatrix}
\cos(a_{u,k})\cos(e_{u,k})&\sin(a_{u,k})\cos(e_{u,k})&\sin(e_{u,k})
\end{bmatrix}^{T}
\end{eqnarray}
where $\phi_{u,k}=(a_{u,k},e_{u,k})\in\Phi= (0,2\pi)\times (-\pi/2,\pi/2)$

 \bigskip
Similar equations can be written for the reference system (SREF). 
\begin{eqnarray}
\label{eq:signalsF}
\left\{
\begin{array}{rcl}
X_{r,1}(f)&=&H_{u,1}(f) (v_{r,1,x}G_{x}(f)+v_{r,1,y}G_{y}(f)+v_{r,1,z}G_{z}(f))
\\
X_{r,2}(f)&=&H_{r,2}(f) (v_{r,2,x}G_{x}(f)+v_{r,2,y}G_{y}(f)+v_{r,2,z}G_{z}(f))
\\
X_{r,3}(f)&=&H_{r,3}(f) (v_{r,3,x}G_{x}(f)+v_{r,3,y}G_{y}(f)+v_{r,3,z}G_{z}(f))
\end{array}
\right.
\end{eqnarray}




In our protocol, the  SREF is a portable seismic device whose the trihedron  is perfectly known. 
Therefore we have in the absence of noise, for $k=1$ to $k=3$:
\begin{eqnarray}
\label{eq:signalmodel}
\left\{
\renewcommand\arraystretch{1.8}
\begin{array}{rcl}
X_{u,k}(f)&=&H_{u,k}(f)v_{u,k}^{T}G(f)
\\
X_{r}(f)&=&H_{r}(f)V_{r}G(f)
\end{array}
\right.
\end{eqnarray}
where
\begin{eqnarray*}
H_{r}(f)&=&\begin{bmatrix}
H_{r,1}(f)&0&0
\\
0&H_{r,2}(f)&0
\\
0&0&H_{r,3}(f)
\end{bmatrix}
\end{eqnarray*}
and where $V_{r}$ is a square matrix of size 3, whose rows are 3 unitary vectors of length $3$, whose parametrization form could be $v^{T}(\phi_{r,k})$.


The objective is to estimate $v_{u,k}$, knowing:
\begin{itemize}
\item
$X_{u}(f)$ and $X_{r}(f)$ which are vectors of size 3 (observed),
\item
$H_{u,k}(f)$ and $H_{r}(f)$ which are square matrices of size 3 (known),
\item
$V_{r}$ is square matrix of size 3 (known),
\end{itemize}
%=====================================
%=====================================
\section{Resolution w.r.t. $v_{u}$}
%=====================================
In this section we assume that we perfectly know the response $H_{u,k}(f)$ along the $k$ axis of the SUT. Then solving the second equation of \eqref{eq:signalmodel} w.r.t. $G(f)$, we get:
\begin{eqnarray}
\label{eq:XuasXr}
H_{u,k}^{-1}(f)X_{u,k}(f)&=&v_{u}^{T}V ^{-1}H_{r}^{-1}(f)X_{r}(f)
\end{eqnarray}
Multiplying on the RHS by $X_{r}^{H}(f)$ leads to
\begin{eqnarray*}
H_{u,k}^{-1}(f)X_{u,k}(f)X_{r}^{H}(f)&=&v_{u}^{T}V _{r}^{-1}H_{r}^{-1}(f)X_{r}(f)X_{r}^{H}(f)
\end{eqnarray*}
Integrating w.r.t. $f$ leads to the expression
\begin{eqnarray}
\label{eq:integrateonf}
\sum_{f} H_{u,k}^{-1}(f)X_{u,k}(f)X_{r}^{H}(f)&=&
v_{u}^{T}V_{r}^{-1}
\sum_{f} H_{r}^{-1}(f)X_{r}(f)X_{r}^{H}(f)
\end{eqnarray}
Letting
\begin{eqnarray*}
S_{ur,k}&=&\sum_{m=0}^{N-1} H_{u,k}^{-1}(f_{m})X_{u,k}(f_{m})X_{r}^{H}(f)
\end{eqnarray*}
and 
\begin{eqnarray*}
S_{rr}&=&\sum_{m=0}^{N-1} H_{r}^{-1}(f_{m})X_{r}(f_{m})X_{r}^{H}(f)
\end{eqnarray*}
where $S_{ur,k}$ is a 3D vector and $S_{rr}$ a $3$D positive square matrix (then inversible if of full rank), 
we derive:
\begin{eqnarray}
\label{eq:linearmodel}
S_{ur,k}&=&v_{u}^{T}V_{r}^{-1}S_{rr}
\end{eqnarray}
Let us define the cost function:
\begin{eqnarray}
\label{eq:pbtosolve}
J_{k}(v) &=&  \|S_{ur,k} - v^{T}V_{r}^{-1}(\phi_{r})S_{rr}\|^{2}
\end{eqnarray}
The least square approach leads to the optimization problem:
\begin{eqnarray}
 \label{eq:hatphi}
v_{k} &=& \arg\min_{v} J_{k}(v)
\end{eqnarray}
under the constraint that $v^{T}v=1$.

 
%================================================
\subsubsection{Analytical resolution}
 %================================================

Letting $A=S_{rr}^{H}V^{-H}(\phi_{r})$ and $s=S_{ur,k}^{H}$, the problem writes:
\begin{eqnarray*}
\min_{v} \| s - Av\|^{2}, \quad \mathrm{under\,the\,constraint}\quad v^{H}v=1
 \end{eqnarray*}
Lagrangian approach leads to:
\begin{eqnarray*}
A^{H}(s-Av)&=&\lambda v
\end{eqnarray*}
then
\begin{eqnarray*}
v&=&
(A^{H}A+\lambda I)^{-1}A^{H}s
\end{eqnarray*}
with $\lambda$ s.t.
\begin{eqnarray*}
s^{H}A(A^{H}A+\lambda I)^{-2}A^{H}s&=&1
\end{eqnarray*}
Letting $W=A^{H}S$
\begin{eqnarray*}
W^{H}(A^{H}A+\lambda I)^{-2}W&=&1
\end{eqnarray*}
Using eigendecomposition of $A^{H}A$ we have:
\begin{eqnarray*}
(A^{H}A+\lambda I)^{-2}&=&\sum_{n}(\mu_{n}+\lambda)^{-2} a_{n}a_{n}^{H}
\end{eqnarray*}
and 
\begin{eqnarray*}
\sum_{n}(\mu_{n}+\lambda)^{-2} \underbrace{W^{H}a_{n}a_{n}^{H}W}_{\gamma_{n}}&=&1
\end{eqnarray*}
therefore
\begin{eqnarray*}
\frac{\gamma_{1}}{(\mu_{1}+\lambda)^{2}}
+\frac{\gamma_{2}}{(\mu_{2}+\lambda)^{2}}
+\frac{\gamma_{3}}{(\mu_{3}+\lambda)^{2}}&=&1
\end{eqnarray*}
Finally we have the 6th degree equation in $\lambda$:
\begin{eqnarray*}
&&(\mu_{1}+\lambda)^{2}(\mu_{2}+\lambda)^{2}(\mu_{3}+\lambda)^{2}
\\
&&\hspace{2cm}
-\gamma_{1}(\mu_{2}+\lambda)^{2}(\mu_{3}+\lambda)^{2}
-\gamma_{2}(\mu_{1}+\lambda)^{2}(\mu_{3}+\lambda)^{2}
-\gamma_{3}(\mu_{2}+\lambda)^{2}(\mu_{1}+\lambda)^{2}
= 0
\end{eqnarray*}
That leads to the following coefficient list:
\begin{eqnarray*}
\lambda^{0}&:&
\mu_{1}^2\mu_{2}^2\mu_{3}^2 - \gamma_{3}\mu_{1}^2\mu_{2}^2 - \gamma_{2}\mu_{1}^2\mu_{3}^2 - \gamma_{1}\mu_{2}^2\mu_{3}^2
\\
\lambda^{1}&:&
2\mu_{1}^2\mu_{2}^2\mu_{3} + 2\mu_{1}^2\mu_{2}\mu_{3}^2 - 2\gamma_{3}\mu_{1}^2\mu_{2} \\
&&- 2\gamma_{2}\mu_{1}^2\mu_{3} + 2\mu_{1}\mu_{2}^2\mu_{3}^2 - 2\gamma_{3}\mu_{1}\mu_{2}^2 - 2\gamma_{2}\mu_{1}\mu_{3}^2 - 2\gamma_{1}\mu_{2}^2\mu_{3} - 2\gamma_{1}\mu_{2}\mu_{3}^2
\\
\lambda^{2}&:&
\mu_{1}^2\mu_{2}^2 - \gamma_{2}\mu_{1}^2 - \gamma_{1}\mu_{3}^2 - \gamma_{3}\mu_{1}^2 - \gamma_{2}\mu_{3}^2 - \gamma_{3}\mu_{2}^2 - \gamma_{1}\mu_{2}^2 + \mu_{1}^2\mu_{3}^2 \\
&&+ \mu_{2}^2\mu_{3}^2 + 4\mu_{1}\mu_{2}\mu_{3}^2 + 4\mu_{1}\mu_{2}^2\mu_{3} + 4\mu_{1}^2\mu_{2}\mu_{3} - 4\gamma_{1}\mu_{2}\mu_{3} - 4\gamma_{2}\mu_{1}\mu_{3} - 4\gamma_{3}\mu_{1}\mu_{2}
\\
\lambda^{3}&:&
2\mu_{1}\mu_{2}^2 - 2\gamma_{2}\mu_{1} - 2\gamma_{1}\mu_{3} - 2\gamma_{3}\mu_{1} - 2\gamma_{2}\mu_{3} - 2\gamma_{3}\mu_{2} - 2\gamma_{1}\mu_{2} + 2\mu_{1}^2\mu_{2} \\
&&+ 2\mu_{1}\mu_{3}^2 + 2\mu_{1}^2\mu_{3} + 2\mu_{2}\mu_{3}^2 + 2\mu_{2}^2\mu_{3} + 8\mu_{1}\mu_{2}\mu_{3}
\\
\lambda^{4}&:&
\mu_{1}^2 + 4\mu_{1}\mu_{2} + 4\mu_{1}\mu_{3} + \mu_{2}^2 + 4\mu_{2}\mu_{3} + \mu_{3}^2 - \gamma_{1} - \gamma_{2} - \gamma_{3}
\\
\lambda^{5}&:&2\mu_{1} + 2\mu_{2} + 2\mu_{3}
\\
\lambda^{6}&:&1
\end{eqnarray*}
We obtain 6 roots and you select that of them giving  the minimum value of the cost function.
%=====================================
 \subsubsection{Simulation}
 
We generate, from a white process, a 3D acceleration vector as a function of time. 

We compute the three components of the accelerometer for the two given trihedron, one for the SUT  the other for the SREF, and for a given set of three frequency responses for the SUT and the same for the SREF. All these responses are computed via poles and zeroes and are a littlebit randomly modified. The difference between the true direction angles and the expected values are reported figure \ref{fig:boxplotoaande}. By this way we simulate $N$ samples:
\begin{eqnarray*}
\label{eq:signalsT}
\left\{
\begin{array}{rcl}
x_{u,1}(t)&=&h_{u,1}(t)\star (v_{u,1,x}g_{x}(t)+v_{u,1,y}g_{y}(t)+v_{u,1,z}g_{z}(t)+b_{1}(t))
\\
x_{u,2}(t)&=&h_{u,2}(t)\star (v_{u,2,x}g_{x}(t)+v_{u,2,y}g_{y}(t)+v_{u,2,z}g_{z}(t)+b_{2}(t))
\\
x_{u,3}(t)&=&h_{u,3}(t)\star (v_{u,3,x}g_{x}(t)+v_{u,3,y}g_{y}(t)+v_{u,3,z3}g_{z}(t)+b_{3}(t))
\end{array}
\right.
\end{eqnarray*}

\figscale{boxplotoaande.pdf}{}{fig:boxplotoaande}{1}

It is worth to notice that, if we assume that the frequency response $H_{u}(f)$ of the SUT is unknown but depends on a $P$-dimensional parameter, this can be estimated using the same cost function. As an example $a$ could be the locations of the poles and zeroes of the transfer function.
%%=====================================
%%=====================================
%\section{Resolution with unknown sensor response}
%%=====================================
%In this section Then:
%
%\begin{eqnarray}
%[\hat \phi, \hat a] &=& \arg\min_{\phi, a} \|S_{uu}(a)S_{ru}^{-1} V_{r}- V_{u}(\phi)\|^{2}
%\end{eqnarray}
%where 
%\begin{eqnarray}
%S_{uu}(a) &=&
%\sum H_{u}^{-1}(f;a)X_{u}(f)X_{u}^{H}(f)
%\end{eqnarray}
%which can be solved numerically with reasonable computational effort, with a  main issue on the locations of the poles that must be inside the unit circle.
%

%=====================================
%=====================================
\appendix
\section{Function}

{\tiny \verbatiminput{../progs/extract1direction.m}}


\section{Program}

{\tiny \verbatiminput{../progs/estimate3Dsystem.m}}


\subsubsection{Useful function}

{\tiny \verbatiminput{../progs/matrixtrihedron.m}}

\end{document}



